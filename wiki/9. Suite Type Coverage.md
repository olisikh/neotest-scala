# Suite Type Coverage (Gaps + Complexity)

This page is a gap analysis of which *suite styles* (and common test-definition shapes) are currently supported for the libraries that `neotest-scala` supports, and what is still missing.

## How The Adapter Works (Relevant Bits)

- **Discovery**: framework modules in `lua/neotest-scala/framework/*/init.lua` use Treesitter queries (and, for specs2 TextSpec, a custom parser) to build neotest positions.
- **Build tool**: commands are built via `lua/neotest-scala/build.lua`. Tool selection is pinned into `spec.env.build_tool`.
- **Results**:
  - If `spec.env.build_tool == "bloop"`, results come from `framework.parse_stdout_results(output, tree)`.
  - Otherwise, results come from JUnit XML in `target/test-reports/` via `framework.build_namespace(...)` + `framework.build_position_result(...)`.
  - Some frameworks are **forced to sbt** even when the selected tool is `bloop` (see `build.enforce_framework_tool`).

Complexity in this doc is relative to the current codebase and patterns already implemented.

## ScalaTest

### Currently Detected

Detection is gated by `extends` checks in `lua/neotest-scala/framework/scalatest/init.lua`:

- `AnyFunSuite` / `*FunSuite`
- `AnyFreeSpec` / `*FreeSpec`
- `AnyFlatSpec` / `*FlatSpec`
- `AnyPropSpec` / `*PropSpec`
- `AnyWordSpec` / `*WordSpec`
- `AnyFunSpec` / `*FunSpec`
- `AnyFeatureSpec` / `*FeatureSpec`
- `AnyRefSpec` / `*RefSpec`

And then these syntaxes are discovered:

- FunSuite: `test("name") { ... }`
- FreeSpec: `"context" - { ... }` and `"test" in { ... }` (with nesting)
- FlatSpec: `"subject" should "do X" in { ... }` and `it should "do X" in { ... }`
- WordSpec: `"context" should { "test" in { ... } }`
- FunSpec: `describe("context") { it("test") { ... } }`
- FeatureSpec: `Feature("X") { Scenario("Y") { ... } }`
- RefSpec: ``def `test name`(): Unit = { ... }``

### Popular Suite Types Currently Missing (Within ZIO 2 Scope)

No major suite-style gaps are currently tracked for ScalaTest beyond output/matching edge cases.

### Complexity Assessment

- **Low**: additional Async*/Fixture* variants for already-supported DSLs (mostly style marker updates).
- **Low**: incremental parser/matching robustness improvements for edge-case naming/output formats.

## munit

### Currently Detected

Detection in `lua/neotest-scala/framework/munit/init.lua` covers:

- `extends FunSuite` / `munit.FunSuite`
- `extends CatsEffectSuite`
- `extends ScalaCheckSuite`
- `extends DisciplineSuite`
- `extends ZSuite` / `ZIOSuite`
- Test-definition syntax: `test("name")`, `property("name")`, `testZ("name")`

### Popular Suite Types Currently Missing

- **Custom wrapper base traits** over munit ecosystem suites
  - Some codebases define project-specific aliases/traits around `FunSuite`, `CatsEffectSuite`, or `ZIOSuite`.
  - If wrappers do not include recognizable markers in source, static detection may still miss them.

### Complexity Assessment

- **Low**: broaden detection for additional known ecosystem base traits.
- **Medium**: improve stdout parsing robustness for variants that change output formatting under `bloop` (if encountered).

## specs2

### Currently Detected

Detection in `lua/neotest-scala/framework/specs2/init.lua`:

- “TextSpec” via `s2""" ... """` (custom parser in `lua/neotest-scala/framework/specs2/textspec.lua`)
- “Mutable-ish” via `extends Specification` with infix patterns like:
  - `"name" >> { ... }`
  - `"name" in { ... }`
  - `"name" ! expression` (basic immutable fragments)

### Popular Suite Types / Shapes Currently Missing

specs2 has many ways to express examples/fragments; the current implementation covers only a subset:

- **Fragments-heavy immutable specs**
  - Advanced immutable composition styles still vary and may not map cleanly to current parsing heuristics.

### Complexity Assessment

- **Medium**: improve advanced immutable/fragment parsing coverage without regressing existing mutable/TextSpec behavior.
- **High**: robust support for all fragments-based forms and mixed immutable DSL shapes.

## utest

### Currently Detected

Detection in `lua/neotest-scala/framework/utest/init.lua` is relatively permissive and targets:

- `object/class ... extends TestSuite` (and a broad `utest` marker)
- `test("name") { ... }` (including nested `test("outer") { test("inner") { ... } }`)

### Common Missing Shapes

- **Non-literal test names**:
  - `test(s"computed $name") { ... }` or `test(nameVar) { ... }`
  - Current Treesitter queries only match literal `(string)` nodes.
  - Even if discovered, result matching can be unreliable because the runtime name is not trivially recoverable.

### Complexity Assessment

- **Low**: more robust namespace detection if users define suites in unconventional structures.
- **High**: supporting non-literal test names in a way that still round-trips to runner output/JUnit IDs.

## zio-test

### Currently Detected

Detection in `lua/neotest-scala/framework/zio-test/init.lua` looks for:

- `extends ZIOSpecDefault` or a `zio.test` marker
- Calls to `test("name")`, `suite("name")`, `suiteAll("name")`

### Popular Suite Types Currently Missing

- **Alternative base traits**
  - Some ZIO 2 codebases use different base traits or wiring patterns than `ZIOSpecDefault`.

### Complexity Assessment

- **Medium**: broaden detection for additional ZIO 2 base traits when the DSL is still `test/suite`.
- **Out of scope**: ZIO 1.x compatibility.

## Cross-Cutting Gaps (Affect Multiple Frameworks)

These aren’t “suite types” per se, but they are common in real code and currently reduce discovery/matching quality:

- **Interpolated/non-literal test names** (`s"..."`, `nameVar`, concatenation)
  - Discovery may be possible, but result matching is hard because names are runtime-evaluated.
- **Generated tests** (loops, property-based generators producing dynamic names)
  - Typically not reliably discoverable statically without executing code.
- **Nested test-path fidelity**
  - Some styles require reconstructing a full hierarchical path for single-test runs (FreeSpec already needed special handling).

## Suggested Implementation Order (Most Value per Effort)

1. **specs2: expand fragment-heavy immutable forms** (parser work; higher risk).
